\documentclass{article}
\usepackage{amsmath}
\usepackage[margin=1in]{geometry}
\input{macros.tex}

\begin{document}

% Some document settings
\setlength\parindent{0pt}

% Document preamble
\title{1D ADCIRC Derivation}
\author{Tristan Dyer}
\maketitle

% First section is the derivation of the SWE starting with the continuity equation
\section{Continuity Equation}

Start with the vertically integrated continuity equation:

% (1)
\begin{align*}
	\ddt{H} + \ddx{}(UH) = 0	\eqlabel{eq1} \\
\end{align*}

where

\begin{align*}
	H		&\equiv	\zeta + h \\
	\zeta	&=		\text{free surface departure from the geoid} \\
	h 		&=		\text{bathymetric depth (distance from the geoid to the bottom)} \\
	u 		&=		\text{vertically varying velocity in the x-direction} \\
	U 		&=		\frac{1}{H}\int_{-h}^\zeta u \mathrm{d}z = \text{depth-averaged velocity in the x-direction} \\
\end{align*}

Take \(\partial/\partial t\) of \eqref{eq2}:

% (2)
\begin{align*}
	\dddt{H} + \ddx{}\ddt{}(UH) = 0		\eqlabel{eq2} \\
\end{align*}

Add \eqref{eq2} to \eqref{eq1} multiplied by the parameter \(\tau_0\), which may be variable in space:

% (3)
\begin{align*}
	\dddt{H} + \ddx{}\ddt{}(UH) + \tau_0\left(\ddt{H} + \ddx{}(UH)\right)	&= 0 \\\\
	\dddt{H} + \ddx{}\ddt{}(UH) + \tau_0\ddt{H} + \tau_0\ddx{}(UH) 			&= 0 \\\\
	\dddt{H} + \tau_0\ddt{H} + \tau_0\ddx{}(UH) + \ddx{}\ddt{}(UH)			&= 0 \eqlabel{eq3} \\
\end{align*}

Now, define \(\Jx\):

% (4), (5)
\begin{align*}
	\Jx &\equiv \tau_0 (UH) + \ddt{}(UH) 	\eqlabel{eq4} \\\\
	\Jx &=		\tau_0 Q + \ddt{Q} 			\eqlabel{eq5} \\\\
	\intertext{where}
	Q &= UH \\
\end{align*}

Recall that \(\tau_0\), \(U\), and \(H\) are all variable in \(x\) and take \(\partial/\partial x\) of \eqref{eq5}, noting the use of the product rule:

% (6)
\begin{align*}
	\ddx{\Jx}	&= \ddx{}\left[\tau_0 Q + \ddt{Q}\right] \\\\
				&= \ddx{}(\tau_0 Q) + \ddx{}\ddt{}Q \\\\
				&= Q\ddx{\tau_0} + \tau_0\ddx{Q} + \ddx{}\ddt{}Q \\\\
				&= \tau_0\ddx{Q} + \ddx{}\ddt{}Q + Q\ddx{\tau_0} \\\\
				&= \tau_0\ddx{(UH)} + \ddx{}\ddt{}(UH) + UH\ddx{\tau_0} \eqlabel{eq6} \\
\end{align*}

Now, returning to equation \eqref{eq3}, let's add zero to it in the form of:

\begin{align*}
	UH\ddx{\tau_0} - UH\ddx{\tau_0}	&= 0 \\\\
	\dddt{H} +  \tau_0\ddt{H} +
		\underbrace{\eqstrut{2.5ex}
			\tau_0\ddx{}(UH) + \ddx{}\ddt{}(UH) + UH\ddx{\tau_0}
		}_\text{
			Note that this is equivalent to \eqref{eq6}
		} - 
	UH\ddx{\tau_0} &= 0 \\
\end{align*}

and substituting \eqref{eq6} in gives us:

% (7)
\begin{align*}
	\dddt{H} + \tau_0\ddt{H} + \ddx{\Jx} - UH\ddx{\tau_0} = 0 \eqlabel{eq7} \\
\end{align*}

If we assume that bathymetric depth is constant, then

\begin{align*}
	\ddt{H} &= \ddt{\zeta} \\\\
	\dddt{H} &= \dddt{\zeta} \\
\end{align*}

and \eqref{eq7} can be rewritten as

% (8)
\begin{align*}
	\dddt{\zeta} + \tau_0\ddt{\zeta} + \ddx{\Jx} - UH\ddx{\tau_0} = 0 \eqlabel{eq8} \\
\end{align*}

\subsection{Apply the weighted residual method}

First, we'll define the inner product notation \(\inner{A}{B}\) as the integral over the domain \(\Omega\) of \(A\) and \(B\) multiplied together.

\begin{align*}
	\inner{A}{B} \equiv \int\limits_\Omega ABd\Omega
\end{align*}

We apply the weighted residual method to \eqref{eq8} by multiplying each term by a weighting function \(\phi_j\) and integrating over the horizontal computational domain \(\Omega\). Written using the inner product notation, we have

% (9)
\begin{align*}
	\inner{\dddt{\zeta}}{\phi_j} + 
	\inner{\tau_0\ddt{\zeta}}{\phi_j} +
	\inner{\ddx{\Jx}}{\phi_j} -
	\inner{UH\ddx{\tau_0}}{\phi_j} = 0 \eqlabel{eq9} \\
\end{align*}

The third term, which involves \(\Jx\), can be integrated using integration by parts. Recall that integration by parts is defined as

\begin{align*}
	\int udv = uv - \int vdu\\
\end{align*}

So looking at the third term from \eqref{eq9},

\begin{align*}
	\inner{\ddx{\Jx}}{\phi_j} = \int \phi_j \ddx{\Jx} dx \\
\end{align*}

we see that if

\begin{align*}
	u				&=	\phi_j 						&	v 				&= \Jx \\
	\frac{du}{dx}	&=	\frac{d\phi_j}{dx} 			&	\frac{dv}{dx}	&= \frac{d\Jx}{dx} \\
	du 				&=	\frac{d\phi_j}{dx} dx 		&	dv 				&= \frac{d\Jx}{dx}dx \\
\end{align*}

then we can use integration by parts, leaving us with

% (10)
\begin{align*}
	\inner{\ddx{\Jx}}{\phi_j} 	&= \int \phi_j \ddx{\Jx} dx \\
								&= \phi_j \Jx - \int \Jx \frac{d\phi_j}{dx} dx \\
								&= \phi_j \Jx - \inner{\Jx}{\frac{d\phi_j}{dx}} \eqlabel{eq10} \\
\end{align*}

Substituting this back in to \eqref{eq8} gives us

\begin{align*}
	\inner{\dddt{\zeta}}{\phi_j} + 
	\inner{\tau_0\ddt{\zeta}}{\phi_j} -
	\inner{\Jx}{\frac{d\phi_j}{dx}} -
	\inner{UH\ddx{\tau_0}}{\phi_j} +
	\phi_j \Jx = 0
\end{align*}

\end{document}